{% extends 'layout.html' %}
{% block content %}
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
                è¿‘30å¤©è€ƒå‹¤æ‰“å¡è®°å½•ï¼ˆéƒ¨é—¨ç­›é€‰ï¼‰
            </div>

            <div class="panel-body">
                <form method="get" class="form-inline" style="margin-bottom: 15px;">
                    <label for="dept">é€‰æ‹©éƒ¨é—¨ï¼š</label>
                    <select name="dept" id="dept" class="form-control" onchange="this.form.submit()">
                        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                        {% for dept in dept_list %}
                            <option value="{{ dept.id }}" {% if dept.id == selected_dept %}selected{% endif %}>
                                {{ dept.title }}
                            </option>
                        {% endfor %}
                    </select>
                </form>

                <div style="overflow-x:auto;">
                    <table class="table table-bordered table-striped table-hover text-center">
                        <thead>
                        <tr>
                            <th>å‘˜å·¥</th>
                            {% for date in date_list %}
                                <th>{{ date|date:"m-d" }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in attendance_data %}
                            <tr>
                                <td>{{ row.user.name }}</td>
                                {% for mark in row.records %}
                                    <td>{% if mark == "âˆš" %}<span style="color:green;">âˆš</span>{% else %}
                                        <span style="color:red;">Ã—</span>{% endif %}</td>
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ date_list|length|add:1 }}">æš‚æ— æ•°æ®</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ğŸ‘‡ æ¨¡æ‹Ÿè¯·å‡å’ŒåŠ ç­å®¡æ‰¹åŒºåŸŸ -->
        <!-- è¯·å‡å®¡æ‰¹åŒºåŸŸï¼ˆå¸¦çŠ¶æ€é€‰æ‹©ï¼‰ -->
        <form method="post" action="/attendance/leave/update/" onsubmit="return confirmApproval(this);">
            {% csrf_token %}
            <div class="panel panel-default">
                <div class="panel-heading">ğŸ“Œ è¯·å‡å®¡æ‰¹</div>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>ç”³è¯·äºº</th>
                        <th>è¯·å‡ç±»å‹</th>
                        <th>æ—¶é—´èŒƒå›´</th>
                        <th>åŸå› </th>
                        <th>çŠ¶æ€</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for leave in leaves %}
                        <tr>
                            <td>{{ leave.user.name }}</td>
                            <td>{{ leave.leave_type }}</td>
                            <td>{{ leave.start_time }} ~ {{ leave.end_time }}</td>
                            <td>{{ leave.reason }}</td>
                            <td>
                                <select name="status_{{ leave.id }}" class="form-control input-sm approval-select">
                                    <option value="pending" {% if leave.status == "pending" %}selected{% endif %}>
                                        å¾…å®¡æ‰¹
                                    </option>
                                    <option value="approved" {% if leave.status == "approved" %}selected{% endif %}>
                                        å·²é€šè¿‡
                                    </option>
                                    <option value="rejected" {% if leave.status == "rejected" %}selected{% endif %}>
                                        å·²æ‹’ç»
                                    </option>

                                </select>
                                <input type="hidden" name="leave_ids[]" value="{{ leave.id }}">
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div style="text-align: right; padding: 10px;">
                    <button type="submit" class="btn btn-primary btn-sm btn-submit">æäº¤è¯·å‡å®¡æ‰¹</button>
                    <button type="button" class="btn btn-warning btn-sm btn-edit" style="display:none;"
                            onclick="enableEdit(this.form)">ç¼–è¾‘
                    </button>
                </div>
            </div>
        </form>

        <!-- âœ… åŠ ç­å®¡æ‰¹è¡¨å• -->
        <form method="post" action="/attendance/overtime/update/" onsubmit="return confirmApproval(this);">
            {% csrf_token %}
            <div class="panel panel-default">
                <div class="panel-heading">ğŸ“Œ åŠ ç­å®¡æ‰¹</div>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>ç”³è¯·äºº</th>
                        <th>åŠ ç­æ—¶é—´</th>
                        <th>åŸå› </th>
                        <th>çŠ¶æ€</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for ot in overtimes %}
                        <tr>
                            <td>{{ ot.user.name }}</td>
                            <td>{{ ot.start_time }} ~ {{ ot.end_time }}</td>
                            <td>{{ ot.reason }}</td>
                            <td>
                                <select name="status_{{ ot.id }}" class="form-control input-sm approval-select">
                                    <option value="pending" {% if ot.status == "pending" %}selected{% endif %}>
                                        å¾…å®¡æ‰¹
                                    </option>
                                    <option value="approved" {% if ot.status == "approved" %}selected{% endif %}>
                                        å·²é€šè¿‡
                                    </option>
                                    <option value="rejected" {% if ot.status == "rejected" %}selected{% endif %}>
                                        å·²æ‹’ç»
                                    </option>

                                </select>
                                <input type="hidden" name="overtime_ids[]" value="{{ ot.id }}">
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div style="text-align: right; padding: 10px;">
                    <button type="submit" class="btn btn-primary btn-sm btn-submit">æäº¤åŠ ç­å®¡æ‰¹</button>
                    <button type="button" class="btn btn-warning btn-sm btn-edit" style="display:none;"
                            onclick="enableEdit(this.form)">ç¼–è¾‘
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- <script>
        function confirmApproval(form) {
            const confirmed = confirm("ç¡®å®šè¦æäº¤å®¡æ‰¹çŠ¶æ€å—ï¼Ÿ");
            if (confirmed) {
                const selects = form.querySelectorAll("select.approval-select");
                selects.forEach(sel => sel.setAttribute("disabled", "disabled"));
                form.querySelector(".btn-submit").style.display = "none";
                form.querySelector(".btn-edit").style.display = "inline-block";
            }
            return confirmed;
        }

        function enableEdit(form) {
            const selects = form.querySelectorAll("select.approval-select");
            selects.forEach(sel => sel.removeAttribute("disabled"));
            form.querySelector(".btn-submit").style.display = "inline-block";
            form.querySelector(".btn-edit").style.display = "none";
        }
    </script> -->

    <script>
        window.onload = function () {
            console.log("ğŸ”’ é¡µé¢åŠ è½½å®Œæˆï¼Œé”å®šå®¡æ‰¹é¡¹");
            document.querySelectorAll("form[onsubmit]").forEach(form => {
                const selects = form.querySelectorAll("select.approval-select");
                selects.forEach(sel => sel.setAttribute("disabled", "disabled"));
                form.querySelector(".btn-submit").style.display = "none";
                form.querySelector(".btn-edit").style.display = "inline-block";
            });
        }

        function confirmApproval(form) {
            const confirmed = confirm("ç¡®å®šè¦æäº¤å®¡æ‰¹çŠ¶æ€å—ï¼Ÿ");
            if (confirmed) {
                // âœ… æäº¤å‰ç§»é™¤ disabled æ‰èƒ½è®© select çš„å€¼éšè¡¨å•æäº¤
                const selects = form.querySelectorAll("select.approval-select");
                selects.forEach(sel => sel.removeAttribute("disabled"));
            }
            return confirmed;
        }

        function enableEdit(form) {
            const selects = form.querySelectorAll("select.approval-select");
            selects.forEach(sel => sel.removeAttribute("disabled"));
            form.querySelector(".btn-submit").style.display = "inline-block";
            form.querySelector(".btn-edit").style.display = "none";
        }
    </script>



{% endblock %}



